name: Release macOS Application

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags like v1.0.0, v1.2.3, etc.

env:
  APP_NAME: howlerops
  BUNDLE_ID: com.howlerops.app

jobs:
  release-macos:
    name: Build and Release macOS App (Unsigned)
    runs-on: macos-latest

    steps:
      # ============================================================
      # STEP 1: CHECKOUT AND SETUP
      # ============================================================

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      # ============================================================
      # STEP 2: INSTALL DEPENDENCIES
      # ============================================================

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Install create-dmg for DMG creation
        run: npm install -g create-dmg

      # ============================================================
      # STEP 3: CODE SIGNING (DISABLED)
      # ============================================================
      # Code signing is disabled. To enable:
      # 1. Get an Apple Developer account ($99/year)
      # 2. Add these GitHub secrets:
      #    - APPLE_CERTIFICATE_P12 (base64 encoded .p12 file)
      #    - APPLE_CERTIFICATE_PASSWORD
      #    - APPLE_TEAM_ID
      #    - APPLE_DEVELOPER_ID (Apple ID email)
      #    - APPLE_APP_PASSWORD (app-specific password)
      # 3. Uncomment the code signing steps below
      # ============================================================

      # - name: Import code signing certificate
      #   env:
      #     CERTIFICATE_P12: ${{ secrets.APPLE_CERTIFICATE_P12 }}
      #     CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
      #   run: |
      #     echo "$CERTIFICATE_P12" | base64 --decode > certificate.p12
      #     security create-keychain -p actions build.keychain
      #     security default-keychain -s build.keychain
      #     security unlock-keychain -p actions build.keychain
      #     security import certificate.p12 -k build.keychain -P "$CERTIFICATE_PASSWORD" -T /usr/bin/codesign
      #     security set-keychain-settings -lut 21600 build.keychain
      #     security set-key-partition-list -S apple-tool:,apple: -s -k actions build.keychain
      #     security find-identity -v -p codesigning build.keychain
      #     rm certificate.p12

      # ============================================================
      # STEP 4: BUILD APPLICATION
      # ============================================================

      - name: Build Wails application (Universal Binary)
        run: |
          wails build -platform darwin/universal -clean

          # Verify the app was built
          if [ ! -d "build/bin/$APP_NAME.app" ]; then
            echo "Error: Application not built successfully"
            exit 1
          fi

          echo "Build successful: build/bin/$APP_NAME.app"
          ls -lah build/bin/

      # ============================================================
      # STEP 5: CODE SIGNING (DISABLED)
      # ============================================================

      # - name: Sign application
      #   env:
      #     APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      #   run: |
      #     IDENTITY=$(security find-identity -v -p codesigning build.keychain | grep "Developer ID Application" | head -1 | awk '{print $2}')
      #     echo "Using identity: $IDENTITY"
      #     codesign --deep --force --verify --verbose \
      #       --sign "$IDENTITY" \
      #       --options runtime \
      #       --entitlements build/darwin/entitlements.plist \
      #       --timestamp \
      #       "build/bin/$APP_NAME.app"
      #     codesign -dv --verbose=4 "build/bin/$APP_NAME.app"
      #     echo "Code signing successful"

      # ============================================================
      # STEP 6: CREATE DISTRIBUTION PACKAGES
      # ============================================================

      - name: Create ZIP archive
        run: |
          cd build/bin

          # Create ZIP (Homebrew friendly)
          zip -r "../../${APP_NAME}-darwin-universal.zip" "$APP_NAME.app"

          cd ../..

          # Verify ZIP was created
          ls -lah "${APP_NAME}-darwin-universal.zip"

          echo "ZIP_PATH=${APP_NAME}-darwin-universal.zip" >> $GITHUB_ENV

      - name: Create DMG (for direct downloads)
        continue-on-error: true  # Don't fail workflow if DMG creation fails (disk space issues)
        run: |
          # Create a nicely formatted DMG
          create-dmg \
            --volname "HowlerOps" \
            --window-pos 200 120 \
            --window-size 658 498 \
            --icon-size 128 \
            --icon "$APP_NAME.app" 180 170 \
            --hide-extension "$APP_NAME.app" \
            --app-drop-link 480 170 \
            "${APP_NAME}-darwin-universal.dmg" \
            "build/bin/$APP_NAME.app" \
            || true  # create-dmg may return non-zero even on success

          # If create-dmg failed, fall back to hdiutil
          if [ ! -f "${APP_NAME}-darwin-universal.dmg" ]; then
            echo "create-dmg failed, using hdiutil instead"
            hdiutil create -volname "HowlerOps" \
              -srcfolder "build/bin/$APP_NAME.app" \
              -ov -format UDZO \
              "${APP_NAME}-darwin-universal.dmg" \
              || echo "‚ö†Ô∏è  DMG creation failed - continuing with ZIP-only release"
          fi

          # Set DMG_PATH if DMG was created successfully
          if [ -f "${APP_NAME}-darwin-universal.dmg" ]; then
            ls -lah "${APP_NAME}-darwin-universal.dmg"
            echo "DMG_PATH=${APP_NAME}-darwin-universal.dmg" >> $GITHUB_ENV
          else
            echo "‚ö†Ô∏è  DMG not created - release will include ZIP only"
            echo "DMG_PATH=" >> $GITHUB_ENV  # Empty value, won't add file to release
          fi

      # ============================================================
      # STEP 7: NOTARIZATION (DISABLED)
      # ============================================================
      # Notarization is disabled. To enable, uncomment the steps below
      # and ensure you have code signing enabled first.
      # ============================================================

      # - name: Notarize application
      #   env:
      #     APPLE_ID: ${{ secrets.APPLE_DEVELOPER_ID }}
      #     APPLE_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
      #     APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      #   run: |
      #     echo "Submitting ZIP for notarization..."
      #     xcrun notarytool submit "$ZIP_PATH" \
      #       --apple-id "$APPLE_ID" \
      #       --password "$APPLE_PASSWORD" \
      #       --team-id "$APPLE_TEAM_ID" \
      #       --wait \
      #       --timeout 30m
      #     if [ $? -eq 0 ]; then
      #       echo "Notarization successful!"
      #     else
      #       echo "Notarization failed!"
      #       exit 1
      #     fi

      # - name: Staple notarization ticket
      #   run: |
      #     unzip -q "$ZIP_PATH" -d build/notarized
      #     xcrun stapler staple "build/notarized/$APP_NAME.app"
      #     xcrun stapler validate "build/notarized/$APP_NAME.app"
      #     cd build/notarized
      #     zip -r "../../${APP_NAME}-darwin-universal.zip" "$APP_NAME.app"
      #     cd ../..
      #     if [ -f "$DMG_PATH" ]; then
      #       xcrun stapler staple "$DMG_PATH"
      #       xcrun stapler validate "$DMG_PATH"
      #     fi
      #     echo "Stapling successful"

      # ============================================================
      # STEP 8: VERIFICATION (DISABLED)
      # ============================================================

      # - name: Verify app integrity
      #   run: |
      #     codesign -vvv --deep --strict "build/notarized/$APP_NAME.app"
      #     spctl -a -vvv "build/notarized/$APP_NAME.app"
      #     echo "‚úÖ Application is properly signed and notarized!"

      # ============================================================
      # STEP 9: CALCULATE CHECKSUMS
      # ============================================================

      - name: Calculate SHA256 checksums
        run: |
          # Calculate SHA256 for ZIP
          ZIP_SHA256=$(shasum -a 256 "$ZIP_PATH" | awk '{print $1}')
          echo "ZIP_SHA256=$ZIP_SHA256" >> $GITHUB_ENV
          echo "ZIP SHA256: $ZIP_SHA256"

          # Calculate SHA256 for DMG
          if [ -f "$DMG_PATH" ]; then
            DMG_SHA256=$(shasum -a 256 "$DMG_PATH" | awk '{print $1}')
            echo "DMG_SHA256=$DMG_SHA256" >> $GITHUB_ENV
            echo "DMG SHA256: $DMG_SHA256"
          fi

          # Save to file for release notes
          cat > checksums.txt << EOF
          SHA256 Checksums:

          ZIP: $ZIP_SHA256
          DMG: ${DMG_SHA256:-N/A}
          EOF

      # ============================================================
      # STEP 10: CREATE GITHUB RELEASE
      # ============================================================

      - name: Generate release notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## HowlerOps ${{ steps.version.outputs.version }}

          ### ‚ö†Ô∏è Important: Unsigned Application

          This application is **not code-signed or notarized** by Apple. To run it:

          1. Download the DMG or ZIP file
          2. Extract and move to Applications folder
          3. First time: **Right-click** the app and select **Open**
          4. Click **Open** in the security dialog
          5. App will run normally from then on

          Alternatively, you can allow it in **System Settings > Privacy & Security**

          ### Installation

          **Direct Download:**
          - Download the DMG or ZIP file below
          - Open the DMG or unzip the file
          - Drag HowlerOps to your Applications folder
          - Follow the instructions above for first launch

          **Homebrew (Coming Soon):**
          ```bash
          brew tap jbeck018/howlerops
          brew install --cask howlerops
          ```

          ### What's New

          $(git log $(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")..HEAD --pretty=format:"- %s (%an)" 2>/dev/null || echo "Initial release")

          ### Verification

          **SHA256 Checksums:**
          - ZIP: `${{ env.ZIP_SHA256 }}`
          - DMG: `${{ env.DMG_SHA256 }}`

          ### System Requirements

          - macOS 11.0 (Big Sur) or later
          - Universal Binary (Intel & Apple Silicon)

          ---

          ü§ñ Built and released automatically by GitHub Actions
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ${{ env.ZIP_PATH }}
            ${{ env.DMG_PATH }}
            checksums.txt
          body_path: release_notes.md
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ============================================================
      # STEP 11: UPDATE HOMEBREW FORMULA (OPTIONAL)
      # ============================================================
      # To enable Homebrew distribution:
      # 1. Create a repository: homebrew-howlerops
      # 2. Add HOMEBREW_TAP_TOKEN to GitHub secrets
      # 3. Uncomment the step below
      # ============================================================

      # - name: Update Homebrew Cask formula
      #   env:
      #     HOMEBREW_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
      #     VERSION: ${{ steps.version.outputs.version }}
      #   run: |
      #     git clone https://x-access-token:${HOMEBREW_TOKEN}@github.com/jbeck018/homebrew-howlerops.git homebrew-tap
      #     cd homebrew-tap
      #     cat > Casks/howlerops.rb << EOF
      #     cask "howlerops" do
      #       version "$VERSION"
      #       sha256 "$ZIP_SHA256"
      #
      #       url "https://github.com/jbeck018/howlerops/releases/download/v#{version}/howlerops-darwin-universal.zip"
      #       name "HowlerOps"
      #       desc "A powerful desktop SQL client built with Wails"
      #       homepage "https://github.com/jbeck018/howlerops"
      #
      #       livecheck do
      #         url :url
      #         strategy :github_latest
      #       end
      #
      #       app "howlerops.app"
      #
      #       zap trash: [
      #         "~/Library/Application Support/howlerops",
      #         "~/Library/Caches/howlerops",
      #         "~/Library/Preferences/$BUNDLE_ID.plist",
      #         "~/Library/Saved Application State/$BUNDLE_ID.savedState",
      #       ]
      #     end
      #     EOF
      #     git config user.name "github-actions[bot]"
      #     git config user.email "github-actions[bot]@users.noreply.github.com"
      #     git add Casks/howlerops.rb
      #     git commit -m "chore: update howlerops to v$VERSION"
      #     git push origin main
      #     echo "‚úÖ Homebrew formula updated successfully!"

      # ============================================================
      # STEP 12: CLEANUP
      # ============================================================

      # - name: Cleanup keychain
      #   if: always()
      #   run: |
      #     security delete-keychain build.keychain || true

      # ============================================================
      # STEP 13: NOTIFICATION
      # ============================================================

      - name: Send success notification
        if: success()
        run: |
          echo "‚úÖ Release v${{ steps.version.outputs.version }} completed successfully!"
          echo "üì¶ Artifacts uploaded to GitHub Releases"
          echo "‚ö†Ô∏è  Note: App is unsigned - users will need to right-click > Open on first launch"

      - name: Send failure notification
        if: failure()
        run: |
          echo "‚ùå Release workflow failed!"
          echo "Check the logs above for details"
          exit 1

  # ============================================================
  # OPTIONAL: POST-RELEASE VERIFICATION (DISABLED)
  # ============================================================
  # This job tests Homebrew installation. Enable when you set up the tap.

  # verify-release:
  #   name: Verify Release Installation
  #   runs-on: macos-latest
  #   needs: release-macos
  #   if: success()
  #
  #   steps:
  #     - name: Wait for Homebrew propagation
  #       run: sleep 60
  #
  #     - name: Test Homebrew installation
  #       run: |
  #         brew tap jbeck018/howlerops
  #         brew install --cask howlerops
  #         if [ -d "/Applications/howlerops.app" ]; then
  #           echo "‚úÖ Installation successful!"
  #         else
  #           echo "‚ùå Installation failed!"
  #           exit 1
  #         fi
  #
  #     - name: Verify app launches
  #       run: |
  #         open -a howlerops --args --help || true
  #         echo "‚úÖ Verification complete!"
