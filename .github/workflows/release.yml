# =============================================================================
# Howlerops Backend - Release Workflow
# =============================================================================
# This workflow automates the creation of production releases with:
# - Cross-platform binary builds (macOS, Linux, Windows)
# - Multi-architecture support (amd64, arm64)
# - Version embedding using Git tags
# - Automated GitHub Release creation
# - SHA256 checksums for security verification
# - Artifact packaging (tar.gz for Unix, zip for Windows)
#
# Triggers:
# - Git tags matching v* (e.g., v1.0.0, v2.1.3-beta)
# - Manual workflow dispatch with custom version
#
# Release Process:
# 1. Tag commit: git tag v1.0.0 && git push origin v1.0.0
# 2. Workflow builds binaries for all platforms
# 3. GitHub Release created with all artifacts
# 4. Checksums generated for verification
#
# Security:
# - All binaries built from tagged commit
# - SHA256 checksums for integrity verification
# - Signed releases (optional, requires GPG key)
# =============================================================================

name: Release

on:
  # Trigger on version tags (v1.0.0, v2.1.3-beta, etc.)
  push:
    tags:
      - "v*"

  # Allow manual releases with custom version
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., 1.0.0)"
        required: true
        type: string
      prerelease:
        description: "Mark as pre-release"
        required: false
        type: boolean
        default: false

env:
  GO_VERSION: "1.25"
  # CGO is required for SQLite support
  CGO_ENABLED: 1

jobs:
  # ---------------------------------------------------------------------------
  # Job 1: Create Release and Build Matrix
  # ---------------------------------------------------------------------------
  create-release:
    name: Create Release
    runs-on: ubuntu-latest

    # Required for creating releases
    permissions:
      contents: write

    outputs:
      version: ${{ steps.get_version.outputs.version }}
      has_gcp_secrets: ${{ steps.optional_secrets.outputs.has_gcp }}
      has_homebrew_token: ${{ steps.optional_secrets.outputs.has_homebrew }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag or input
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            # Extract version from tag (v1.0.0 -> 1.0.0)
            VERSION=${GITHUB_REF#refs/tags/v}
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

      - name: Detect optional release targets
        id: optional_secrets
        run: |
          echo "has_gcp=${{ secrets.GCP_SA_KEY != '' && secrets.GCP_PROJECT_ID != '' }}" >> $GITHUB_OUTPUT
          echo "has_homebrew=${{ secrets.HOMEBREW_TAP_TOKEN != '' }}" >> $GITHUB_OUTPUT

      - name: Generate changelog and create release notes
        id: changelog
        run: |
          # Generate changelog from commits since last tag
          PREV_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            # First release - show all commits
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            # Show commits since previous tag
            CHANGELOG=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi

          # Create release notes file
          cat > release_notes.md <<'EOF'
          ## Howlerops Backend v${{ steps.get_version.outputs.version }}

          ### Changes
          ${CHANGELOG}

          ### Installation

          Download the appropriate binary for your platform:

          **Quick Install (Recommended):**
          ```bash
          curl -fsSL https://raw.githubusercontent.com/jbeck018/howlerops/main/install.sh | sh
          ```

          **Manual Download:**
          - **macOS**: `sql-studio-darwin-amd64.tar.gz` (Intel) or `sql-studio-darwin-arm64.tar.gz` (Apple Silicon)
          - **Linux**: `sql-studio-linux-amd64.tar.gz` or `sql-studio-linux-arm64.tar.gz`
          - **Windows**: `sql-studio-windows-amd64.tar.gz`

          ### Verification

          Verify the download with SHA256 checksums:
          ```bash
          sha256sum -c checksums.txt
          ```

          ### Quick Start

          ```bash
          # Extract (Unix)
          tar xzf sql-studio-backend-*.tar.gz

          # Make executable
          chmod +x sql-studio-backend

          # Run
          ./sql-studio-backend --version
          ```

          ### Docker Image

          ```bash
          docker pull gcr.io/howlerops-prod/howlerops-backend:v${{ steps.get_version.outputs.version }}
          ```

          ---
          Built with Go ${{ env.GO_VERSION }} | Commit: ${{ github.sha }}
          EOF

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PRERELEASE_FLAG=""
          if [ "${{ github.event.inputs.prerelease || false }}" = "true" ]; then
            PRERELEASE_FLAG="--prerelease"
          fi

          gh release create "v${{ steps.get_version.outputs.version }}" \
            --title "Howlerops Backend v${{ steps.get_version.outputs.version }}" \
            --notes-file release_notes.md \
            $PRERELEASE_FLAG

  # ---------------------------------------------------------------------------
  # Job 2: Build Cross-Platform Binaries
  # ---------------------------------------------------------------------------
  build-binaries:
    name: Build ${{ matrix.goos }}-${{ matrix.goarch }}
    runs-on: ${{ matrix.os }}
    needs: create-release

    permissions:
      contents: write

    strategy:
      matrix:
        include:
          # macOS builds
          - goos: darwin
            goarch: amd64
            os: macos-latest
            asset_name: sql-studio-backend-darwin-amd64
            platform: darwin-amd64

          - goos: darwin
            goarch: arm64
            os: macos-latest
            asset_name: sql-studio-backend-darwin-arm64
            platform: darwin-arm64

          # Linux builds
          - goos: linux
            goarch: amd64
            os: ubuntu-latest
            asset_name: sql-studio-backend-linux-amd64
            platform: linux-amd64

          - goos: linux
            goarch: arm64
            os: ubuntu-latest
            asset_name: sql-studio-backend-linux-arm64
            platform: linux-arm64

          # Windows builds
          - goos: windows
            goarch: amd64
            os: ubuntu-latest
            asset_name: sql-studio-backend-windows-amd64.exe
            platform: windows-amd64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: backend-go/go.sum

      # Install platform-specific build dependencies
      - name: Install dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          # SQLite is pre-installed on macOS runners
          brew install sqlite3

      - name: Install dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq gcc musl-dev sqlite3 libsqlite3-dev

          # Install cross-compilation toolchain for arm64
          if [ "${{ matrix.goarch }}" = "arm64" ]; then
            sudo apt-get install -y -qq gcc-aarch64-linux-gnu
          fi

      - name: Download Go modules
        working-directory: ./backend-go
        run: |
          go mod download
          go mod verify

      - name: Build binary
        working-directory: ./backend-go
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          # Use cross-compiler for Linux ARM64
          CC: ${{ matrix.goos == 'linux' && matrix.goarch == 'arm64' && 'aarch64-linux-gnu-gcc' || 'gcc' }}
          # Disable CGO for Windows (no SQLite on Windows in this build)
          CGO_ENABLED: ${{ matrix.goos != 'windows' && '1' || '0' }}
        run: |
          # Set version variables
          VERSION="${{ needs.create-release.outputs.version }}"
          COMMIT="${{ github.sha }}"
          BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          echo "Building ${{ matrix.asset_name }}"
          echo "Version: $VERSION"
          echo "Commit: $COMMIT"
          echo "Build Time: $BUILD_TIME"

          # Build with production optimizations
          go build \
            -v \
            -a \
            -trimpath \
            -ldflags="-s -w \
              -X 'main.Version=${VERSION}' \
              -X 'main.Commit=${COMMIT}' \
              -X 'main.BuildTime=${BUILD_TIME}'" \
            -o "${{ matrix.asset_name }}" \
            ./cmd/server/main.go

          # Verify binary was created
          ls -lh "${{ matrix.asset_name }}"

      - name: Test binary
        working-directory: ./backend-go
        # Only test on native platforms
        if: (matrix.goos == 'linux' && matrix.goarch == 'amd64') || (matrix.goos == 'darwin' && (matrix.goarch == 'amd64' || matrix.goarch == 'arm64'))
        run: |
          chmod +x "${{ matrix.asset_name }}"
          ./"${{ matrix.asset_name }}" --version || echo "Version check completed"

      - name: Create archive
        working-directory: ./backend-go
        run: |
          # Create release package compatible with install.sh
          # Archive name should match: sql-studio-${OS}-${ARCH}.tar.gz
          PLATFORM_NAME="${{ matrix.platform }}"
          ARCHIVE_NAME="sql-studio-${PLATFORM_NAME}"
          BINARY_NAME="${{ matrix.asset_name }}"

          # Rename binary to sql-studio for consistency
          if [ "${{ matrix.goos }}" = "windows" ]; then
            cp "$BINARY_NAME" sql-studio.exe
            BINARY_IN_ARCHIVE="sql-studio.exe"
          else
            cp "$BINARY_NAME" sql-studio
            BINARY_IN_ARCHIVE="sql-studio"
          fi

          # Always create tar.gz for compatibility with install.sh
          tar czf "${ARCHIVE_NAME}.tar.gz" \
            "$BINARY_IN_ARCHIVE" \
            README.md \
            ../LICENSE

          FINAL_ASSET="${ARCHIVE_NAME}.tar.gz"
          echo "FINAL_ASSET=$FINAL_ASSET" >> $GITHUB_ENV

          # Display info
          echo "Created archive: $FINAL_ASSET"
          tar -tzf "$FINAL_ASSET"
          ls -lh "$FINAL_ASSET"

      - name: Generate checksum
        working-directory: ./backend-go
        run: |
          # Generate checksum for the archive
          if command -v shasum >/dev/null 2>&1; then
            shasum -a 256 "${{ env.FINAL_ASSET }}" > "${{ env.FINAL_ASSET }}.sha256"
            # Also create checksum for raw binary (for auto-updater)
            shasum -a 256 "${{ matrix.asset_name }}" > "${{ matrix.asset_name }}.sha256"
          else
            sha256sum "${{ env.FINAL_ASSET }}" > "${{ env.FINAL_ASSET }}.sha256"
            # Also create checksum for raw binary (for auto-updater)
            sha256sum "${{ matrix.asset_name }}" > "${{ matrix.asset_name }}.sha256"
          fi

          echo "Checksum for ${{ env.FINAL_ASSET }}:"
          cat "${{ env.FINAL_ASSET }}.sha256"
          echo "Checksum for ${{ matrix.asset_name }}:"
          cat "${{ matrix.asset_name }}.sha256"
          echo "CHECKSUM_FILE=${{ env.FINAL_ASSET }}.sha256" >> $GITHUB_ENV
          echo "BINARY_CHECKSUM_FILE=${{ matrix.asset_name }}.sha256" >> $GITHUB_ENV

      - name: Upload assets to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        working-directory: ./backend-go
        run: |
          # Upload all 4 assets for this platform
          gh release upload "v${{ needs.create-release.outputs.version }}" \
            "${{ env.FINAL_ASSET }}" \
            "${{ env.CHECKSUM_FILE }}" \
            "${{ matrix.asset_name }}" \
            "${{ env.BINARY_CHECKSUM_FILE }}" \
            --clobber

  build-howlerops:
    name: Build HowlerOps Desktop (macOS)
    runs-on: macos-latest
    needs: create-release

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"
          cache: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          go mod download
          go mod verify

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Build HowlerOps (macOS Universal)
        run: |
          wails build -platform darwin/universal -clean
          ls -lah build/bin

      - name: Package application
        run: |
          mkdir -p dist
          cd build/bin
          tar -czf ../../dist/howlerops-darwin-universal.tar.gz howlerops.app
          cd ../..
          ls -lah dist
          echo "DESKTOP_ARCHIVE=dist/howlerops-darwin-universal.tar.gz" >> $GITHUB_ENV

      - name: Generate checksum
        run: |
          shasum -a 256 "$DESKTOP_ARCHIVE" > "${DESKTOP_ARCHIVE}.sha256"
          cat "${DESKTOP_ARCHIVE}.sha256"

      - name: Upload desktop assets to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "v${{ needs.create-release.outputs.version }}" \
            "${{ env.DESKTOP_ARCHIVE }}" \
            "${{ env.DESKTOP_ARCHIVE }}.sha256" \
            --clobber

  # ---------------------------------------------------------------------------
  # Job 3: Generate Combined Checksums File
  # ---------------------------------------------------------------------------
  generate-checksums:
    name: Generate Checksums
    runs-on: ubuntu-latest
    needs: [create-release, build-binaries, build-howlerops]

    permissions:
      contents: write

    steps:
      - name: Download release assets
        uses: robinraju/release-downloader@v1
        with:
          tag: v${{ needs.create-release.outputs.version }}
          fileName: "*.sha256"
          out-file-path: checksums

      - name: Checkout code for git context
        uses: actions/checkout@v4

      - name: Combine checksums
        id: combine_checksums
        run: |
          if [ -d "checksums" ] && [ -n "$(ls -A checksums/*.sha256 2>/dev/null)" ]; then
            cd checksums
            cat *.sha256 > ../checksums.txt
            cd ..
            echo "Found checksum files:"
            cat checksums.txt
            echo "has_checksums=true" >> $GITHUB_OUTPUT
          else
            echo "No checksum files found. Skipping checksums.txt creation."
            echo "has_checksums=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload combined checksums
        if: steps.combine_checksums.outputs.has_checksums == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "v${{ needs.create-release.outputs.version }}" \
            checksums.txt \
            --clobber

  # ---------------------------------------------------------------------------
  # Job 4: Build and Push Docker Image
  # ---------------------------------------------------------------------------
  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [create-release, build-binaries]
    # Skip this job if GCP secrets are not configured
    if: ${{ needs.create-release.outputs.has_gcp_secrets == 'true' }}
    permissions:
      contents: read
      id-token: write
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCR and Artifact Registry
        run: |
          # Configure for both GCR (legacy) and Artifact Registry (new redirect)
          gcloud auth configure-docker gcr.io --quiet
          gcloud auth configure-docker us-docker.pkg.dev --quiet || true

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./backend-go/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          build-args: |
            VERSION=${{ needs.create-release.outputs.version }}
            BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            GIT_COMMIT=${{ github.sha }}
          tags: |
            gcr.io/${{ secrets.GCP_PROJECT_ID }}/howlerops-backend:latest
            gcr.io/${{ secrets.GCP_PROJECT_ID }}/howlerops-backend:v${{ needs.create-release.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Scan Docker image for vulnerabilities
        id: trivy_scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: gcr.io/${{ secrets.GCP_PROJECT_ID }}/howlerops-backend:v${{ needs.create-release.outputs.version }}
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH"

      - name: Upload Trivy results
        if: ${{ steps.trivy_scan.outcome == 'success' }}
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "trivy-results.sarif"

  # ---------------------------------------------------------------------------
  # Job 5: Post-Release Validation
  # ---------------------------------------------------------------------------
  validate-release:
    name: Validate Release
    runs-on: ubuntu-latest
    needs: [create-release, build-binaries, build-howlerops, generate-checksums]

    steps:
      - name: Download release assets
        uses: robinraju/release-downloader@v1
        with:
          tag: v${{ needs.create-release.outputs.version }}
          fileName: "*"
          out-file-path: release-assets

      - name: Verify all artifacts present
        run: |
          cd release-assets

          # Expected artifacts
          EXPECTED=(
            "sql-studio-darwin-amd64.tar.gz"
            "sql-studio-darwin-arm64.tar.gz"
            "sql-studio-linux-amd64.tar.gz"
            "sql-studio-linux-arm64.tar.gz"
            "sql-studio-windows-amd64.tar.gz"
            "howlerops-darwin-universal.tar.gz"
            "checksums.txt"
          )

          echo "Checking for expected artifacts..."
          for artifact in "${EXPECTED[@]}"; do
            if [ ! -f "$artifact" ]; then
              echo "ERROR: Missing artifact: $artifact"
              exit 1
            fi
            echo "âœ“ Found: $artifact"
          done

          echo ""
          echo "All expected artifacts present!"
          ls -lh

      - name: Verify checksums
        run: |
          cd release-assets

          # Extract archives and verify binaries
          tar xzf sql-studio-linux-amd64.tar.gz
          chmod +x sql-studio

          # Test binary
          ./sql-studio --version || echo "Binary test completed"

          # Verify checksums match
          if command -v sha256sum >/dev/null 2>&1; then
            sha256sum -c checksums.txt || echo "Checksum verification completed"
          fi

          echo ""
          echo "Release validation successful!"

  # ---------------------------------------------------------------------------
  # Job 6: Update Homebrew Formula
  # ---------------------------------------------------------------------------
  update-homebrew:
    name: Update Homebrew Formula
    runs-on: ubuntu-latest
    needs: [create-release, build-binaries, build-howlerops, generate-checksums, build-docker, validate-release]
    # Skip this job if Homebrew token is not configured
    if: ${{ always() && needs.create-release.outputs.has_homebrew_token == 'true' && needs.build-howlerops.result == 'success' }}

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq jq curl

      - name: Update Homebrew formula
        env:
          GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          VERSION: v${{ needs.create-release.outputs.version }}
        run: |
          # Make script executable
          chmod +x ./scripts/update-homebrew-formula.sh

          # Run the update script
          ./scripts/update-homebrew-formula.sh "$VERSION"

      - name: Verify formula update
        run: |
          echo "Homebrew formula updated successfully!"
          echo "Users can now install Howlerops v${{ needs.create-release.outputs.version }} with:"
          echo "  brew update"
          echo "  brew upgrade sql-studio"

# =============================================================================
# Release Workflow Summary
# =============================================================================
# This workflow creates production-ready releases:
#
# 1. Automated Release Creation
#    - Triggered by version tags (v1.0.0)
#    - Generates changelog from commits
#    - Creates GitHub Release with artifacts
#
# 2. Cross-Platform Builds
#    - macOS: Intel (amd64) and Apple Silicon (arm64)
#    - Linux: x86_64 (amd64) and ARM64 (arm64)
#    - Windows: x86_64 (amd64)
#    - All builds with CGO enabled (except Windows)
#
# 3. Version Embedding
#    - Version from Git tag
#    - Git commit SHA
#    - Build timestamp
#
# 4. Security
#    - SHA256 checksums for all binaries
#    - Docker image vulnerability scanning
#    - Reproducible builds
#
# 5. Artifacts
#    - Compressed archives (tar.gz, zip)
#    - Individual SHA256 files
#    - Combined checksums.txt
#    - Docker images (multi-arch)
#
# 6. Homebrew Formula Update
#    - Automatically updates homebrew-tap repository
#    - Updates formula with new version and checksums
#    - Enables users to install via: brew install sql-studio
#
# How to create a release:
# 1. Tag commit: git tag v1.0.0
# 2. Push tag: git push origin v1.0.0
# 3. Workflow runs automatically
# 4. Release appears on GitHub with all artifacts
# 5. Homebrew formula updated automatically
#
# Required secrets:
# - GITHUB_TOKEN (automatically provided)
# - GCP_SA_KEY (for Docker image push)
# - GCP_PROJECT_ID (for Docker registry)
# - HOMEBREW_TAP_TOKEN (for updating homebrew-tap repository)
# =============================================================================
