# =============================================================================
# Howlerops Backend - Release Workflow
# =============================================================================
# This workflow automates the creation of production releases with:
# - Cross-platform binary builds (macOS, Linux, Windows)
# - Multi-architecture support (amd64, arm64)
# - Version embedding using Git tags
# - Automated GitHub Release creation
# - SHA256 checksums for security verification
# - Artifact packaging (tar.gz for Unix, zip for Windows)
#
# Triggers:
# - Git tags matching v* (e.g., v1.0.0, v2.1.3-beta)
# - Manual workflow dispatch with custom version
#
# Release Process:
# 1. Tag commit: git tag v1.0.0 && git push origin v1.0.0
# 2. Workflow builds binaries for all platforms
# 3. GitHub Release created with all artifacts
# 4. Checksums generated for verification
#
# Security:
# - All binaries built from tagged commit
# - SHA256 checksums for integrity verification
# - Signed releases (optional, requires GPG key)
# =============================================================================

name: Release

on:
  # Trigger on version tags (v1.0.0, v2.1.3-beta, etc.)
  push:
    tags:
      - "v*"

  # Allow manual releases with custom version
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., 1.0.0)"
        required: true
        type: string
      prerelease:
        description: "Mark as pre-release"
        required: false
        type: boolean
        default: false

env:
  GO_VERSION: "1.25"
  # CGO is required for SQLite support
  CGO_ENABLED: 1

jobs:
  # ---------------------------------------------------------------------------
  # Job 1: Create Release and Build Matrix
  # ---------------------------------------------------------------------------
  create-release:
    name: Create Release
    runs-on: ubuntu-latest

    # Required for creating releases
    permissions:
      contents: write

    outputs:
      version: ${{ steps.get_version.outputs.version }}
      has_gcp_secrets: ${{ steps.optional_secrets.outputs.has_gcp }}
      has_homebrew_token: ${{ steps.optional_secrets.outputs.has_homebrew }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag or input
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            # Extract version from tag (v1.0.0 -> 1.0.0)
            VERSION=${GITHUB_REF#refs/tags/v}
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

      - name: Detect optional release targets
        id: optional_secrets
        run: |
          echo "has_gcp=${{ secrets.GCP_SA_KEY != '' && secrets.GCP_PROJECT_ID != '' }}" >> $GITHUB_OUTPUT
          echo "has_homebrew=${{ secrets.HOMEBREW_TAP_TOKEN != '' }}" >> $GITHUB_OUTPUT

      - name: Generate changelog and create release notes
        id: changelog
        run: |
          # Generate changelog from commits since last tag
          PREV_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            # First release - show all commits
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            # Show commits since previous tag
            CHANGELOG=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi

          # Create release notes file
          cat > release_notes.md <<'EOF'
          ## Howlerops Backend v${{ steps.get_version.outputs.version }}

          ### Changes
          ${CHANGELOG}

          ### Installation

          Download the appropriate binary for your platform:

          **Quick Install (Recommended):**
          ```bash
          curl -fsSL https://raw.githubusercontent.com/jbeck018/howlerops/main/install.sh | sh
          ```

          **Manual Download:**
          - **macOS**: `sql-studio-darwin-amd64.tar.gz` (Intel) or `sql-studio-darwin-arm64.tar.gz` (Apple Silicon)
          - **Linux**: `sql-studio-linux-amd64.tar.gz` or `sql-studio-linux-arm64.tar.gz`
          - **Windows**: `sql-studio-windows-amd64.tar.gz`

          ### Verification

          Verify the download with SHA256 checksums:
          ```bash
          sha256sum -c checksums.txt
          ```

          ### Quick Start

          ```bash
          # Extract (Unix)
          tar xzf sql-studio-backend-*.tar.gz

          # Make executable
          chmod +x sql-studio-backend

          # Run
          ./sql-studio-backend --version
          ```

          ### Docker Image

          ```bash
          docker pull gcr.io/howlerops-prod/howlerops-backend:v${{ steps.get_version.outputs.version }}
          ```

          ---
          Built with Go ${{ env.GO_VERSION }} | Commit: ${{ github.sha }}
          EOF

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PRERELEASE_FLAG=""
          if [ "${{ github.event.inputs.prerelease || false }}" = "true" ]; then
            PRERELEASE_FLAG="--prerelease"
          fi

          gh release create "v${{ steps.get_version.outputs.version }}" \
            --title "Howlerops Backend v${{ steps.get_version.outputs.version }}" \
            --notes-file release_notes.md \
            $PRERELEASE_FLAG

  # ---------------------------------------------------------------------------
  # Job 2: Build Cross-Platform Binaries
  # ---------------------------------------------------------------------------
  build-binaries:
    name: Build ${{ matrix.goos }}-${{ matrix.goarch }}
    runs-on: ${{ matrix.os }}
    needs: create-release

    permissions:
      contents: write

    strategy:
      matrix:
        include:
          # macOS builds
          - goos: darwin
            goarch: amd64
            os: macos-latest
            asset_name: sql-studio-backend-darwin-amd64
            platform: darwin-amd64

          - goos: darwin
            goarch: arm64
            os: macos-latest
            asset_name: sql-studio-backend-darwin-arm64
            platform: darwin-arm64

          # Linux builds
          - goos: linux
            goarch: amd64
            os: ubuntu-latest
            asset_name: sql-studio-backend-linux-amd64
            platform: linux-amd64

          - goos: linux
            goarch: arm64
            os: ubuntu-latest
            asset_name: sql-studio-backend-linux-arm64
            platform: linux-arm64

          # Windows builds
          - goos: windows
            goarch: amd64
            os: ubuntu-latest
            asset_name: sql-studio-backend-windows-amd64.exe
            platform: windows-amd64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: backend-go/go.sum

      # Install platform-specific build dependencies
      - name: Install dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          # SQLite is pre-installed on macOS runners
          brew install sqlite3

      - name: Install dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq gcc musl-dev sqlite3 libsqlite3-dev

          # Install cross-compilation toolchain for arm64
          if [ "${{ matrix.goarch }}" = "arm64" ]; then
            sudo apt-get install -y -qq gcc-aarch64-linux-gnu
          fi

      - name: Download Go modules
        working-directory: ./backend-go
        run: |
          go mod download
          go mod verify

      - name: Build binary
        working-directory: ./backend-go
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          # Use cross-compiler for Linux ARM64
          CC: ${{ matrix.goos == 'linux' && matrix.goarch == 'arm64' && 'aarch64-linux-gnu-gcc' || 'gcc' }}
          # Disable CGO for Windows (no SQLite on Windows in this build)
          CGO_ENABLED: ${{ matrix.goos != 'windows' && '1' || '0' }}
        run: |
          # Set version variables
          VERSION="${{ needs.create-release.outputs.version }}"
          COMMIT="${{ github.sha }}"
          BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          echo "Building ${{ matrix.asset_name }}"
          echo "Version: $VERSION"
          echo "Commit: $COMMIT"
          echo "Build Time: $BUILD_TIME"

          # Build with production optimizations
          go build \
            -v \
            -a \
            -trimpath \
            -ldflags="-s -w \
              -X 'main.Version=${VERSION}' \
              -X 'main.Commit=${COMMIT}' \
              -X 'main.BuildTime=${BUILD_TIME}'" \
            -o "${{ matrix.asset_name }}" \
            ./cmd/server/main.go

          # Verify binary was created
          ls -lh "${{ matrix.asset_name }}"

      - name: Test binary
        working-directory: ./backend-go
        # Only test on native platforms
        if: (matrix.goos == 'linux' && matrix.goarch == 'amd64') || (matrix.goos == 'darwin' && (matrix.goarch == 'amd64' || matrix.goarch == 'arm64'))
        run: |
          chmod +x "${{ matrix.asset_name }}"
          ./"${{ matrix.asset_name }}" --version || echo "Version check completed"

      - name: Create archive
        working-directory: ./backend-go
        run: |
          # Create release package compatible with install.sh
          # Archive name should match: sql-studio-${OS}-${ARCH}.tar.gz
          PLATFORM_NAME="${{ matrix.platform }}"
          ARCHIVE_NAME="sql-studio-${PLATFORM_NAME}"
          BINARY_NAME="${{ matrix.asset_name }}"

          # Rename binary to sql-studio for consistency
          if [ "${{ matrix.goos }}" = "windows" ]; then
            cp "$BINARY_NAME" sql-studio.exe
            BINARY_IN_ARCHIVE="sql-studio.exe"
          else
            cp "$BINARY_NAME" sql-studio
            BINARY_IN_ARCHIVE="sql-studio"
          fi

          # Always create tar.gz for compatibility with install.sh
          tar czf "${ARCHIVE_NAME}.tar.gz" \
            "$BINARY_IN_ARCHIVE" \
            README.md \
            ../LICENSE

          FINAL_ASSET="${ARCHIVE_NAME}.tar.gz"
          echo "FINAL_ASSET=$FINAL_ASSET" >> $GITHUB_ENV

          # Display info
          echo "Created archive: $FINAL_ASSET"
          tar -tzf "$FINAL_ASSET"
          ls -lh "$FINAL_ASSET"

      - name: Generate checksum
        working-directory: ./backend-go
        run: |
          # Generate checksum for the archive
          if command -v shasum >/dev/null 2>&1; then
            shasum -a 256 "${{ env.FINAL_ASSET }}" > "${{ env.FINAL_ASSET }}.sha256"
            # Also create checksum for raw binary (for auto-updater)
            shasum -a 256 "${{ matrix.asset_name }}" > "${{ matrix.asset_name }}.sha256"
          else
            sha256sum "${{ env.FINAL_ASSET }}" > "${{ env.FINAL_ASSET }}.sha256"
            # Also create checksum for raw binary (for auto-updater)
            sha256sum "${{ matrix.asset_name }}" > "${{ matrix.asset_name }}.sha256"
          fi

          echo "Checksum for ${{ env.FINAL_ASSET }}:"
          cat "${{ env.FINAL_ASSET }}.sha256"
          echo "Checksum for ${{ matrix.asset_name }}:"
          cat "${{ matrix.asset_name }}.sha256"
          echo "CHECKSUM_FILE=${{ env.FINAL_ASSET }}.sha256" >> $GITHUB_ENV
          echo "BINARY_CHECKSUM_FILE=${{ matrix.asset_name }}.sha256" >> $GITHUB_ENV

      - name: Upload assets to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        working-directory: ./backend-go
        run: |
          # Upload all 4 assets for this platform
          gh release upload "v${{ needs.create-release.outputs.version }}" \
            "${{ env.FINAL_ASSET }}" \
            "${{ env.CHECKSUM_FILE }}" \
            "${{ matrix.asset_name }}" \
            "${{ env.BINARY_CHECKSUM_FILE }}" \
            --clobber

  build-howlerops:
    name: Build HowlerOps Desktop (macOS)
    runs-on: macos-latest
    needs: create-release

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"
          cache: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          go mod download
          go mod verify

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: |
          # Retry npm ci up to 3 times due to occasional grpc-tools CDN issues
          for i in {1..3}; do
            echo "Attempt $i of 3..."
            if npm ci; then
              echo "npm ci succeeded"
              exit 0
            else
              if [ $i -lt 3 ]; then
                echo "npm ci failed, waiting 30 seconds before retry..."
                sleep 30
              else
                echo "npm ci failed after 3 attempts"
                exit 1
              fi
            fi
          done

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Build HowlerOps (macOS Universal)
        run: |
          wails build -platform darwin/universal -clean
          ls -lah build/bin

      - name: Package application
        run: |
          mkdir -p dist
          cd build/bin
          tar -czf ../../dist/howlerops-darwin-universal.tar.gz howlerops.app
          cd ../..
          ls -lah dist
          echo "DESKTOP_ARCHIVE=dist/howlerops-darwin-universal.tar.gz" >> $GITHUB_ENV

      - name: Generate checksum
        run: |
          shasum -a 256 "$DESKTOP_ARCHIVE" > "${DESKTOP_ARCHIVE}.sha256"
          cat "${DESKTOP_ARCHIVE}.sha256"

      - name: Upload desktop assets to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "v${{ needs.create-release.outputs.version }}" \
            "${{ env.DESKTOP_ARCHIVE }}" \
            "${{ env.DESKTOP_ARCHIVE }}.sha256" \
            --clobber

  # ---------------------------------------------------------------------------
  # Job 3: Generate Combined Checksums File
  # ---------------------------------------------------------------------------
  generate-checksums:
    name: Generate Checksums
    runs-on: ubuntu-latest
    needs: [create-release, build-binaries, build-howlerops]

    permissions:
      contents: write

    steps:
      - name: Download release assets
        uses: robinraju/release-downloader@v1
        with:
          tag: v${{ needs.create-release.outputs.version }}
          fileName: "*.sha256"
          out-file-path: checksums

      - name: Checkout code for git context
        uses: actions/checkout@v4

      - name: Combine checksums
        id: combine_checksums
        run: |
          echo "=== Checking downloaded checksums ==="
          if [ -d "checksums" ]; then
            echo "Contents of checksums directory:"
            ls -lah checksums/ || echo "Directory exists but is empty"
            echo ""
            echo "Searching recursively for .sha256 files:"
            find checksums -name "*.sha256" -type f || echo "No .sha256 files found"
          else
            echo "ERROR: checksums directory does not exist!"
          fi
          echo ""
          
          # Find all .sha256 files recursively
          CHECKSUM_FILES=$(find checksums -name "*.sha256" -type f 2>/dev/null || true)
          
          if [ -n "$CHECKSUM_FILES" ]; then
            echo "Found $(echo "$CHECKSUM_FILES" | wc -l) checksum files"
            echo "Combining checksums..."
            find checksums -name "*.sha256" -type f -exec cat {} \; > checksums.txt
            echo "Combined checksums:"
            cat checksums.txt
            echo "has_checksums=true" >> $GITHUB_OUTPUT
          else
            echo "No checksum files found. Skipping checksums.txt creation."
            echo "has_checksums=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload combined checksums
        if: steps.combine_checksums.outputs.has_checksums == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "v${{ needs.create-release.outputs.version }}" \
            checksums.txt \
            --clobber

  # ---------------------------------------------------------------------------
  # Job 4: Build and Push Docker Image
  # ---------------------------------------------------------------------------
  build-docker:
    name: Build Docker Image (Cloud Build)
    runs-on: ubuntu-latest
    needs: [create-release, build-binaries]
    # Skip this job if GCP secrets are not configured
    if: ${{ needs.create-release.outputs.has_gcp_secrets == 'true' }}
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Set correct GCP project
        run: |
          echo "DEBUG: Current auth account:"
          gcloud auth list
          echo "DEBUG: Service account from credentials:"
          echo '${{ secrets.GCP_SA_KEY }}' | jq -r '.client_email'
          gcloud config set project howlerops-prod
          echo "Active project: $(gcloud config get-value project)"

      - name: Trigger Cloud Build for Docker image
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"
          BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          GIT_COMMIT="${{ github.sha }}"
          REPO_URL="https://github.com/${{ github.repository }}"
          
          echo "Triggering Cloud Build for version ${VERSION}..."
          echo "Building from ${REPO_URL}@${GIT_COMMIT}"
          
          # Build from GitHub - use --async to avoid log streaming permission issues
          BUILD_ID=$(gcloud builds submit \
            --no-source \
            --config=cloudbuild-release.yaml \
            --substitutions=_VERSION="${VERSION}",_BUILD_TIME="${BUILD_TIME}",_GIT_COMMIT="${GIT_COMMIT}",_REPO_URL="${REPO_URL}",_COMMIT_SHA="${GIT_COMMIT}" \
            --project=howlerops-prod \
            --format="value(id)" \
            --async)
          
          echo "Cloud Build triggered successfully!"
          echo "Build ID: ${BUILD_ID}"
          echo "View logs at: https://console.cloud.google.com/cloud-build/builds/${BUILD_ID}?project=howlerops-prod"
          
          # Docker builds typically take 15-20 minutes
          # Wait 2 minutes before starting to poll to reduce API calls
          echo "Waiting 2 minutes before polling (Docker builds take ~20 minutes)..."
          sleep 120
          
          # Poll for build completion (30 minutes max: 90 attempts × 20s)
          echo "Starting to poll build status..."
          for i in {1..90}; do
            STATUS=$(gcloud builds describe ${BUILD_ID} --project=howlerops-prod --format="value(status)" 2>/dev/null || echo "UNKNOWN")
            echo "Build status: ${STATUS} (attempt ${i}/90)"
            
            if [ "$STATUS" = "SUCCESS" ]; then
              echo "Cloud Build completed successfully!"
              echo "Images pushed:"
              echo "  - gcr.io/howlerops-prod/howlerops-backend:${VERSION}"
              echo "  - gcr.io/howlerops-prod/howlerops-backend:latest"
              exit 0
            elif [ "$STATUS" = "FAILURE" ] || [ "$STATUS" = "TIMEOUT" ] || [ "$STATUS" = "CANCELLED" ]; then
              echo "Cloud Build failed with status: ${STATUS}"
              echo "View logs at: https://console.cloud.google.com/cloud-build/builds/${BUILD_ID}?project=howlerops-prod"
              exit 1
            elif [ "$STATUS" = "UNKNOWN" ]; then
              echo "Warning: Unable to query build status, will retry..."
              # Don't exit - continue polling
            elif [ "$STATUS" = "QUEUED" ] || [ "$STATUS" = "WORKING" ]; then
              echo "Build is in progress..."
              # Continue polling
            else
              echo "Unexpected status: ${STATUS}"
              # Continue polling for unexpected statuses
            fi
            
            sleep 20
          done
          
          echo "Build timeout - status check exceeded 30 minutes"
          echo "View logs at: https://console.cloud.google.com/cloud-build/builds/${BUILD_ID}?project=howlerops-prod"
          exit 1

  # ---------------------------------------------------------------------------
  # Job 5: Post-Release Validation
  # ---------------------------------------------------------------------------
  validate-release:
    name: Validate Release
    runs-on: ubuntu-latest
    needs: [create-release, build-binaries, build-howlerops, generate-checksums]

    steps:
      - name: Download release assets
        uses: robinraju/release-downloader@v1
        with:
          tag: v${{ needs.create-release.outputs.version }}
          fileName: "*"
          out-file-path: release-assets

      - name: Verify all artifacts present
        run: |
          cd release-assets

          echo "=== Downloaded artifacts ==="
          ls -lah
          echo ""

          # Required artifacts
          REQUIRED=(
            "sql-studio-darwin-amd64.tar.gz"
            "sql-studio-darwin-arm64.tar.gz"
            "sql-studio-linux-amd64.tar.gz"
            "sql-studio-linux-arm64.tar.gz"
            "sql-studio-windows-amd64.tar.gz"
            "howlerops-darwin-universal.tar.gz"
          )
          
          # Optional artifacts (warn if missing)
          OPTIONAL=(
            "checksums.txt"
          )

          echo "=== Checking for required artifacts ==="
          MISSING_COUNT=0
          for artifact in "${REQUIRED[@]}"; do
            if [ ! -f "$artifact" ]; then
              echo "❌ Missing: $artifact"
              MISSING_COUNT=$((MISSING_COUNT + 1))
            else
              echo "✓ Found: $artifact"
            fi
          done
          
          echo ""
          echo "=== Checking for optional artifacts ==="
          for artifact in "${OPTIONAL[@]}"; do
            if [ ! -f "$artifact" ]; then
              echo "⚠️  Missing (optional): $artifact"
            else
              echo "✓ Found: $artifact"
            fi
          done

          if [ $MISSING_COUNT -gt 0 ]; then
            echo ""
            echo "ERROR: $MISSING_COUNT required artifact(s) missing from release!"
            exit 1
          fi

          echo ""
          echo "✅ All expected artifacts present!"
          ls -lh

      - name: Verify checksums
        run: |
          cd release-assets

          # Extract archives and verify binaries
          tar xzf sql-studio-linux-amd64.tar.gz
          chmod +x sql-studio

          # Test binary
          ./sql-studio --version || echo "Binary test completed"

          # Verify checksums match
          if command -v sha256sum >/dev/null 2>&1; then
            sha256sum -c checksums.txt || echo "Checksum verification completed"
          fi

          echo ""
          echo "Release validation successful!"

  # ---------------------------------------------------------------------------
  # Job 6: Update Homebrew Formula
  # ---------------------------------------------------------------------------
  update-homebrew:
    name: Update Homebrew Formula
    runs-on: ubuntu-latest
    needs: [create-release, build-binaries, build-howlerops, generate-checksums, validate-release]
    # Skip this job if Homebrew token is not configured
    # Run even if optional jobs (like build-docker) are skipped or failed
    if: ${{ always() && needs.create-release.outputs.has_homebrew_token == 'true' && needs.build-howlerops.result == 'success' && needs.validate-release.result == 'success' }}

    permissions:
      contents: read

    steps:
      - name: Wait for GitHub release to stabilize
        run: |
          echo "Waiting 5 minutes for all build jobs to complete and release API to stabilize..."
          echo "This ensures all assets are uploaded and the release is fully indexed."
          echo "Build jobs can take 3-5 minutes to complete."
          sleep 300

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq jq curl

      - name: Update Homebrew formula
        env:
          GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          VERSION: v${{ needs.create-release.outputs.version }}
        run: |
          # Make script executable
          chmod +x ./scripts/update-homebrew-formula.sh

          # Run the update script
          ./scripts/update-homebrew-formula.sh "$VERSION"

      - name: Verify formula update
        run: |
          echo "Homebrew formula updated successfully!"
          echo "Users can now install Howlerops v${{ needs.create-release.outputs.version }} with:"
          echo "  brew update"
          echo "  brew upgrade sql-studio"

# =============================================================================
# Release Workflow Summary
# =============================================================================
# This workflow creates production-ready releases:
#
# 1. Automated Release Creation
#    - Triggered by version tags (v1.0.0)
#    - Generates changelog from commits
#    - Creates GitHub Release with artifacts
#
# 2. Cross-Platform Builds
#    - macOS: Intel (amd64) and Apple Silicon (arm64)
#    - Linux: x86_64 (amd64) and ARM64 (arm64)
#    - Windows: x86_64 (amd64)
#    - All builds with CGO enabled (except Windows)
#
# 3. Version Embedding
#    - Version from Git tag
#    - Git commit SHA
#    - Build timestamp
#
# 4. Security
#    - SHA256 checksums for all binaries
#    - Docker image vulnerability scanning
#    - Reproducible builds
#
# 5. Artifacts
#    - Compressed archives (tar.gz, zip)
#    - Individual SHA256 files
#    - Combined checksums.txt
#    - Docker images (multi-arch)
#
# 6. Homebrew Formula Update
#    - Automatically updates homebrew-tap repository
#    - Updates formula with new version and checksums
#    - Enables users to install via: brew install sql-studio
#
# How to create a release:
# 1. Tag commit: git tag v1.0.0
# 2. Push tag: git push origin v1.0.0
# 3. Workflow runs automatically
# 4. Release appears on GitHub with all artifacts
# 5. Homebrew formula updated automatically
#
# Required secrets:
# - GITHUB_TOKEN (automatically provided)
# - GCP_SA_KEY (for Docker image push)
# - GCP_PROJECT_ID (for Docker registry)
# - HOMEBREW_TAP_TOKEN (for updating homebrew-tap repository)
# =============================================================================
