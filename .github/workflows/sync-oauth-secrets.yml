name: Sync OAuth Secrets to GCP

# This workflow syncs OAuth secrets from GitHub to Google Cloud Secret Manager
# Run manually when secrets need to be updated in GCP

on:
  workflow_dispatch:  # Manual trigger only
    inputs:
      gcp_project_id:
        description: 'GCP Project ID'
        required: true
        default: 'howlerops-prod'

jobs:
  sync-secrets:
    name: Sync OAuth Secrets
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write  # Required for Workload Identity Federation

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          project_id: ${{ github.event.inputs.gcp_project_id }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Sync Google OAuth Client ID
        run: |
          echo "${{ secrets.GOOGLE_CLIENT_ID }}" | \
          gcloud secrets versions add google-oauth-client-id \
            --project=${{ github.event.inputs.gcp_project_id }} \
            --data-file=- 2>/dev/null || \
          echo "${{ secrets.GOOGLE_CLIENT_ID }}" | \
          gcloud secrets create google-oauth-client-id \
            --project=${{ github.event.inputs.gcp_project_id }} \
            --replication-policy="automatic" \
            --data-file=- \
            --labels="app=howlerops,component=oauth,managed-by=github-actions"

      - name: Sync Google OAuth Client Secret
        run: |
          echo "${{ secrets.GOOGLE_CLIENT_SECRET }}" | \
          gcloud secrets versions add google-oauth-client-secret \
            --project=${{ github.event.inputs.gcp_project_id }} \
            --data-file=- 2>/dev/null || \
          echo "${{ secrets.GOOGLE_CLIENT_SECRET }}" | \
          gcloud secrets create google-oauth-client-secret \
            --project=${{ github.event.inputs.gcp_project_id }} \
            --replication-policy="automatic" \
            --data-file=- \
            --labels="app=howlerops,component=oauth,managed-by=github-actions"

      - name: Sync GitHub OAuth Client ID
        run: |
          echo "${{ secrets.GH_CLIENT_ID }}" | \
          gcloud secrets versions add github-oauth-client-id \
            --project=${{ github.event.inputs.gcp_project_id }} \
            --data-file=- 2>/dev/null || \
          echo "${{ secrets.GH_CLIENT_ID }}" | \
          gcloud secrets create github-oauth-client-id \
            --project=${{ github.event.inputs.gcp_project_id }} \
            --replication-policy="automatic" \
            --data-file=- \
            --labels="app=howlerops,component=oauth,managed-by=github-actions"

      - name: Sync GitHub OAuth Client Secret
        run: |
          echo "${{ secrets.GH_CLIENT_SECRET }}" | \
          gcloud secrets versions add github-oauth-client-secret \
            --project=${{ github.event.inputs.gcp_project_id }} \
            --data-file=- 2>/dev/null || \
          echo "${{ secrets.GH_CLIENT_SECRET }}" | \
          gcloud secrets create github-oauth-client-secret \
            --project=${{ github.event.inputs.gcp_project_id }} \
            --replication-policy="automatic" \
            --data-file=- \
            --labels="app=howlerops,component=oauth,managed-by=github-actions"

      - name: Verify secrets
        run: |
          echo "âœ… Secrets synced successfully!"
          echo ""
          echo "Verifying secrets in GCP:"
          gcloud secrets list --project=${{ github.event.inputs.gcp_project_id }} | grep oauth
          echo ""
          echo "Next steps:"
          echo "1. Grant service account access to secrets"
          echo "2. Update cloudbuild.yaml to use these secrets"
          echo "3. Deploy to Cloud Run"
